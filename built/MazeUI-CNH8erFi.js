import{u as e,b as t,j as s}from"./index-D9Aqr53B.js";import{c as l,a6 as n,z as o,aU as i,aV as r,a8 as a,aD as c}from"./react-vendor-DrrN8YCO.js";import{DIFFICULTY_CONFIG as d}from"./Maze-Dvv1I3_X.js";import"./socket-DRbsQkF5.js";import"./zustand-CxtZ_hFH.js";import"./BaseGame-D1CpCHgu.js";const x=({game:x,currentUserId:h})=>{const m=x,[f,u]=l.useState(m.getState()),p=l.useRef(null),g=l.useRef(null),w=l.useRef({}),{ti:b,ts:y}=e(),{confirm:v}=t(),[j,N]=l.useState(30),T=h?f.players[h]:void 0;l.useEffect(()=>m.onUpdate(e=>{u(e)}),[m]);const k=l.useMemo(()=>m.getMazeGrid(),[f.config,f.seed,m]);l.useEffect(()=>{const e=()=>{if(!g.current)return;const{rows:e,cols:t}=f.config,s=Math.min(window.innerWidth-32,800),l=window.innerHeight-180-32,n=Math.floor(s/t),o=Math.floor(l/e);let i=Math.min(n,o);i=Math.max(10,Math.min(i,40)),N(i)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[f.config]),l.useEffect(()=>{const e=p.current;if(!e)return;const t=e.getContext("2d");if(!t)return;const{rows:s,cols:l}=f.config,n=l*j,o=s*j,i=window.devicePixelRatio||1;e.width=n*i,e.height=o*i,e.style.width=`${n}px`,e.style.height=`${o}px`,t.scale(i,i),t.fillStyle="#1a1a1a",t.fillRect(0,0,n,o),t.fillStyle="rgba(34, 197, 94, 0.2)",t.fillRect((l-1)*j,(s-1)*j,j,j),t.fillStyle="rgba(59, 130, 246, 0.2)",t.fillRect(0,0,j,j),t.lineWidth=3;for(let r=0;r<s;r++)for(let e=0;e<l;e++){const s=k[r][e];if(s.portalTo){const l=e*j+j/2,n=r*j+j/2;t.beginPath(),t.arc(l,n,.35*j,0,2*Math.PI),t.fillStyle=s.portalTo.color+"40",t.fill(),t.beginPath(),t.arc(l,n,.25*j,0,2*Math.PI),t.strokeStyle=s.portalTo.color,t.stroke(),t.beginPath(),t.arc(l,n,.1*j,0,2*Math.PI),t.fillStyle=s.portalTo.color,t.fill()}}t.strokeStyle="#4b5563",t.lineWidth=2,t.lineCap="round",t.beginPath();for(let r=0;r<s;r++)for(let e=0;e<l;e++){const s=k[r][e],l=e*j,n=r*j;s.walls.top&&(t.moveTo(l,n),t.lineTo(l+j,n)),s.walls.right&&(t.moveTo(l+j,n),t.lineTo(l+j,n+j)),s.walls.bottom&&(t.moveTo(l,n+j),t.lineTo(l+j,n+j)),s.walls.left&&(t.moveTo(l,n),t.lineTo(l,n+j))}t.stroke()},[k,f.config,j]),l.useEffect(()=>{const e=e=>{if("PLAYING"!==f.status)return;let t=null;"ArrowUp"===e.key&&(t="UP"),"ArrowDown"===e.key&&(t="DOWN"),"ArrowLeft"===e.key&&(t="LEFT"),"ArrowRight"===e.key&&(t="RIGHT")," "===e.key&&P(),t&&(e.preventDefault(),M(t))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[f.status,m]);const E=e=>{const t=f.winners.indexOf(e);return-1===t?void 0:t+1},P=()=>{h&&m.makeAction({type:"TELEPORT",playerId:h})},M=e=>{h&&m.makeAction({type:"MOVE",direction:e,playerId:h})},L=l.useRef(void 0),[R,z]=l.useState(!1);l.useEffect(()=>{let e=!1;const t=()=>{const s=Date.now();if(Object.values(f.players).forEach(e=>{const t=w.current[e.id];if(!t)return;let l=e.x,n=e.y;if(e.moveStart&&e.moveEnd&&e.currentPath&&e.currentPath.length>=2&&s<e.moveEnd){const t=e.moveEnd-e.moveStart,o=s-e.moveStart,i=Math.max(0,Math.min(o/t,1)),r=e.currentPath,a=r.length-1,c=i*a,d=Math.floor(c),x=c-d;if(d<a){const e=r[d],t=r[d+1];l=e.x+(t.x-e.x)*x,n=e.y+(t.y-e.y)*x}}t.style.left=l*j+.15*j+"px",t.style.top=n*j+.15*j+"px",t.style.width=.7*j+"px",t.style.height=.7*j+"px"}),h&&f.players[h]){const t=f.players[h],l=!!(t.moveEnd&&s<t.moveEnd);l!==e&&(e=l,z(l))}L.current=requestAnimationFrame(t)};return L.current=requestAnimationFrame(t),()=>{L.current&&cancelAnimationFrame(L.current)}},[f.players,h,j]);const I=l.useMemo(()=>{if(!T||!k||R)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const{x:e,y:t}=T;if(t<0||e<0||t>=f.config.rows||e>=f.config.cols)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const s=k[t][e];return{UP:!s.walls.top,DOWN:!s.walls.bottom,LEFT:!s.walls.left,RIGHT:!s.walls.right}},[T?.x,T?.y,k,f.config,R]);return s.jsxs("div",{className:"flex flex-col items-center justify-center min-h-full p-4 overflow-hidden pb-16!",ref:g,children:[s.jsx("div",{className:"flex flex-col w-full max-w-2xl bg-gray-800 p-4 rounded-xl shadow-lg gap-4 z-10 shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsx("span",{className:"text-sm text-gray-400",children:"Level"}),s.jsxs("span",{className:"text-xl font-bold text-white flex gap-2 items-center",children:[f.level," ",s.jsx("span",{className:"text-xs text-gray-500 bg-gray-700 px-2 py-0.5 rounded-full",children:f.config.difficulty})]}),m.isHost&&s.jsxs("button",{onClick:async()=>{await v(y({en:"Current progress will be lost",vi:"Tiến trình hiện tại sẽ mất"}),y({en:"Reset Game?",vi:"Chơi lại?"}))&&m.makeAction({type:"RESET_GAME"})},className:"flex items-center gap-2 p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg",title:"Reset Game",children:[s.jsx(n,{size:18}),b({en:"Reset",vi:"Chơi lại"})]})]}),s.jsx("div",{className:"flex flex-col flex-wrap gap-0",children:Object.values(f.players).map(e=>s.jsxs("div",{className:"flex items-center gap-2 p-1.5 px-3 bg-gray-900/50 rounded-lg border border-gray-700/50",children:[s.jsx("div",{className:"w-3 h-3 rounded-full border border-white/20 shrink-0",style:{backgroundColor:e.color}}),s.jsxs("div",{className:"truncate font-medium text-sm text-gray-300 max-w-[100px]",children:[e.username||e.id.slice(0,8),e.id===h&&s.jsxs("span",{className:"text-blue-400 ml-1",children:["(",y({en:"You",vi:"Bạn"}),")"]})]}),E(e.id)&&s.jsxs("span",{className:"text-xs font-bold bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded ml-1",children:["#",E(e.id)]})]},e.id))})]})}),s.jsxs("div",{className:"relative shadow-2xl rounded-lg border border-gray-700 select-none bg-black mt-4 shrink-0 transition-all duration-300",style:{width:f.config.cols*j,height:f.config.rows*j},children:[s.jsxs("div",{className:"absolute inset-0 overflow-hidden rounded-lg",children:[s.jsx("canvas",{ref:p}),Object.values(f.players).map(e=>s.jsx("div",{ref:t=>{w.current[e.id]=t},className:"absolute rounded-full shadow-sm flex items-center justify-center border-2 border-white",style:{width:.7*j+"px",height:.7*j+"px",left:e.x*j+.15*j+"px",top:e.y*j+.15*j+"px",backgroundColor:e.color,zIndex:e.id===h?20:10},children:E(e.id)&&s.jsxs("span",{className:"text-xs font-bold text-white drop-shadow-md",children:["#",E(e.id)]})},e.id)),"WAITING"===f.status&&s.jsxs("div",{className:"absolute inset-0 bg-black/40 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[s.jsx("div",{className:"text-white text-3xl font-bold",children:m.isHost?y({en:"Setup Game",vi:"Cài đặt Game"}):y({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})}),m.isHost&&s.jsxs("div",{className:"flex flex-col gap-4 items-center animate-in fade-in zoom-in duration-300",children:[s.jsx("div",{className:"flex bg-gray-800 rounded-lg p-1.5 ring-1 ring-gray-700",children:Object.keys(d).map(e=>s.jsx("button",{onClick:()=>{return t=e,void m.makeAction({type:"UPDATE_SETTINGS",difficulty:t});var t},className:"px-4 py-2 text-sm font-bold rounded-md transition-all "+(f.config.difficulty===e?"bg-blue-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"),children:e},e))}),s.jsxs("button",{onClick:()=>{m.makeAction({type:"START_GAME"})},className:"flex items-center gap-2 px-8 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-green-500/20 transition-all hover:-translate-y-0.5",children:[s.jsx(o,{size:24,fill:"currentColor"})," ",y({en:"Start Game",vi:"Chơi"})]})]})]}),"FINISHED"===f.status&&s.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[s.jsxs("div",{className:"text-green-400 text-4xl font-bold drop-shadow-[0_0_10px_rgba(74,222,128,0.5)]",children:[y({en:"Level Complete!",vi:"Xong Level"})," ",f.level]}),T&&E(T.id)&&s.jsxs("div",{className:"text-white text-xl",children:[y({en:"You finished",vi:"Bạn về đích"})," ",s.jsxs("span",{className:"font-bold text-yellow-400",children:["#",E(T.id)]})]}),m.isHost?s.jsxs("button",{onClick:()=>{m.makeAction({type:"NEXT_LEVEL"})},className:"flex items-center gap-2 px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-500/20 transition-all hover:-translate-y-0.5",children:[y({en:"Next Level",vi:"Level tiếp theo"})," ",s.jsx(o,{size:24,fill:"currentColor"})]}):s.jsx("div",{children:y({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})})]})]}),(()=>{if("PLAYING"!==f.status||!T||R||E(T.id))return null;const e=40,t=T.x*j+j/2,l=T.y*j+j/2,o=f.config.cols*j,d=f.config.rows*j,x=I.LEFT?60:20,h=I.RIGHT?60:20,m=I.UP?60:20,u=I.DOWN?60:20,p=Math.max(x,Math.min(o-h,t)),g=Math.max(m,Math.min(d-u,l)),w=(e,t)=>({width:"40px",height:"40px",left:p+e-20+"px",top:g+t-20+"px"}),b="absolute flex items-center justify-center bg-white/10 hover:bg-white/40 rounded-full backdrop-blur-sm transition-all hover:scale-110 active:scale-95 z-30 border border-white/10 shadow-lg ring-1 ring-black/20 opacity-50";return s.jsxs(s.Fragment,{children:[I.UP&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),M("UP")},className:b,style:w(0,-40),children:s.jsx(i,{size:24,className:"text-white drop-shadow-md"})}),I.DOWN&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),M("DOWN")},className:b,style:w(0,e),children:s.jsx(r,{size:24,className:"text-white drop-shadow-md"})}),I.LEFT&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),M("LEFT")},className:b,style:w(-40,0),children:s.jsx(a,{size:24,className:"text-white drop-shadow-md"})}),I.RIGHT&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),M("RIGHT")},className:b,style:w(e,0),children:s.jsx(c,{size:24,className:"text-white drop-shadow-md"})}),k[T.y][T.x].portalTo&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),P()},className:"absolute flex items-center justify-center bg-purple-500/80 hover:bg-purple-400 rounded-full backdrop-blur-sm transition-all hover:scale-110 active:scale-95 z-40 border border-white/20 shadow-[0_0_15px_rgba(168,85,247,0.5)] animate-pulse opacity-50",style:{width:"40px",height:"40px",left:p-20+"px",top:g-20+"px"},children:s.jsx(n,{size:24,className:"text-white drop-shadow-md animate-spin",style:{animationDirection:"reverse"}})})]})})()]}),s.jsx("div",{className:"mt-4 text-gray-500 text-sm hidden sm:block",children:y({vi:"Về đích đầu tiên để dành chiến thắng",en:"First to the finish wins!"})})]})};export{x as default};
