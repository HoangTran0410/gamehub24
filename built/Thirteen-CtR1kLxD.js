import{B as t}from"./BaseGame-BxPaRT7T.js";import{S as e,R as s,e as n,C as r,d as i,a}from"./types-CraghUB2.js";import"./socket-DRbsQkF5.js";import"./index-DhsjDdpu.js";import"./react-vendor-h4rhVvwn.js";import"./zustand-Bv_X5X6D.js";class h extends t{isGameOver(t){return"ended"===t.gamePhase}getInitState(){return{players:Array(4).fill(null).map((t,e)=>{const s=this.players[e];return{id:s?.id||null,username:s?.username||`Slot ${e+1}`,hand:[],isBot:!1,isGuest:!1,isHost:s?.id===this.userId,passed:!1}}),currentTrick:[],currentTurnIndex:0,lastPlayedBy:null,lastCombination:null,winner:null,rankings:[],gamePhase:"waiting",newGameRequest:null}}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"PLAY_CARDS":this.handlePlayCards(e.playerId,e.cards);break;case"PASS":this.handlePass(e.playerId);break;case"ADD_BOT":this.handleAddBot(e.slotIndex);break;case"JOIN_SLOT":this.handleJoinSlot(e.slotIndex,e.playerId,e.playerName);break;case"REMOVE_PLAYER":this.handleRemovePlayer(e.slotIndex);break;case"START_GAME":this.handleStartGame();break;case"NEW_GAME":case"ACCEPT_NEW_GAME":this.reset();break;case"REQUEST_NEW_GAME":this.handleNewGameRequest(e.playerId,e.playerName);break;case"DECLINE_NEW_GAME":this.state.newGameRequest=null}}createDeck(){const t=[];for(const r of[e.SPADE,e.CLUB,e.DIAMOND,e.HEART])for(let e=s.THREE;e<=s.TWO;e++)t.push(n(e,r));return t}selectedHandPattern="random";setHandPattern(t){this.selectedHandPattern=t}getHandPattern(){return this.selectedHandPattern}shuffleDeck(t){const e=[...t];for(let s=e.length-1;s>0;s--){const t=Math.floor(Math.random()*(s+1));[e[s],e[t]]=[e[t],e[s]]}return e}dealCards(){let t=this.createDeck();if("random"!==this.selectedHandPattern){const{patternCards:e,remainingDeck:s}=this.extractPattern(t,this.selectedHandPattern),n=[...e,...this.shuffleDeck(s).slice(0,13-e.length)],r=new Set(n),i=this.shuffleDeck(this.createDeck().filter(t=>!r.has(t)));t=[...n,...i]}else t=this.shuffleDeck(t);let e=0;for(const s of this.state.players)null!==s.id&&(s.hand=t.slice(e,e+13),this.sortHand(s.hand),e+=13)}extractPattern(t,e){let n=[];const i=this.groupByRank(t),a=Object.keys(i).map(Number).sort(()=>Math.random()-.5);switch(e){case r.FOUR_OF_KIND:for(const t of a)if(4===i[t].length){n=i[t];break}break;case r.TRIPLE:for(const t of a)if(i[t].length>=3){n=i[t].slice(0,3);break}break;case r.PAIR:for(const t of a)if(i[t].length>=2){n=i[t].slice(0,2);break}break;case r.THREE_CONSECUTIVE_PAIRS:{const t=Array.from({length:s.KING-s.THREE+1},(t,e)=>e+s.THREE).sort(()=>Math.random()-.5);for(const e of t)if(e+2<=s.KING&&i[e]?.length>=2&&i[e+1]?.length>=2&&i[e+2]?.length>=2){n=[...i[e].slice(0,2),...i[e+1].slice(0,2),...i[e+2].slice(0,2)];break}break}case r.FOUR_CONSECUTIVE_PAIRS:{const t=Array.from({length:s.QUEEN-s.THREE+1},(t,e)=>e+s.THREE).sort(()=>Math.random()-.5);for(const e of t)if(e+3<=s.KING&&i[e]?.length>=2&&i[e+1]?.length>=2&&i[e+2]?.length>=2&&i[e+3]?.length>=2){n=[...i[e].slice(0,2),...i[e+1].slice(0,2),...i[e+2].slice(0,2),...i[e+3].slice(0,2)];break}break}case r.STRAIGHT:{const t=Math.floor(5*Math.random())+5,e=Array.from({length:s.ACE-t+1-s.THREE+1},(t,e)=>e+s.THREE).sort(()=>Math.random()-.5);for(const s of e){let e=!0;const r=[];for(let n=0;n<t;n++){if(!(i[s+n]?.length>0)){e=!1;break}r.push(i[s+n][0])}if(e){n=r;break}}break}}const h=new Set(n);return{patternCards:n,remainingDeck:t.filter(t=>!h.has(t))}}sortHand(t){t.sort((t,e)=>t-e)}getCombination(t){if(0===t.length)return null;const e=[...t].sort((t,e)=>t-e);if(1===t.length)return{type:r.SINGLE,cardCount:1,value:e[0]};if(t.every(e=>i(e).rank===i(t[0]).rank)){if(2===t.length)return{type:r.PAIR,cardCount:2,value:e[e.length-1]};if(3===t.length)return{type:r.TRIPLE,cardCount:3,value:e[e.length-1]};if(4===t.length)return{type:r.FOUR_OF_KIND,cardCount:4,value:e[e.length-1]}}if(t.length>=3){if(this.isStraight(e))return{type:r.STRAIGHT,cardCount:t.length,value:100*e[e.length-1]+t.length}}if(6===t.length){if(this.isThreeConsecutivePairs(e))return{type:r.THREE_CONSECUTIVE_PAIRS,cardCount:6,value:e[e.length-1]}}if(8===t.length){if(this.isFourConsecutivePairs(e))return{type:r.FOUR_CONSECUTIVE_PAIRS,cardCount:8,value:e[e.length-1]}}return null}isConsecutivePairs(t,e){if(t.length!==2*e)return!1;for(let n=0;n<e;n++){const r=i(t[2*n]),a=i(t[2*n+1]);if(r.rank!==a.rank)return!1;if(r.rank===s.TWO)return!1;if(n<e-1){if(i(t[2*(n+1)]).rank!==r.rank+1)return!1}}return!0}isThreeConsecutivePairs(t){return this.isConsecutivePairs(t,3)}isFourConsecutivePairs(t){return this.isConsecutivePairs(t,4)}isStraight(t){if(t.some(t=>i(t).rank===s.TWO))return!1;for(let e=1;e<t.length;e++)if(i(t[e]).rank!==i(t[e-1]).rank+1)return!1;return!0}canBeat(t,e){if(!e)return!0;const n=this.state.currentTrick[this.state.currentTrick.length-1]?.cards;if(n&&n.length>0){const a=i(n[0]).rank;if(e.type===r.SINGLE&&a===s.TWO&&(t.type===r.FOUR_OF_KIND||t.type===r.THREE_CONSECUTIVE_PAIRS||t.type===r.FOUR_CONSECUTIVE_PAIRS))return!0;if(e.type===r.PAIR&&a===s.TWO&&(t.type===r.FOUR_OF_KIND||t.type===r.FOUR_CONSECUTIVE_PAIRS))return!0;if(e.type===r.THREE_CONSECUTIVE_PAIRS&&(t.type===r.FOUR_OF_KIND||t.type===r.FOUR_CONSECUTIVE_PAIRS))return!0;if(e.type===r.FOUR_OF_KIND&&t.type===r.FOUR_CONSECUTIVE_PAIRS)return!0}return t.type===e.type&&((t.type!==r.STRAIGHT||t.cardCount===e.cardCount)&&t.value>e.value)}handlePlayCards(t,e){if("playing"!==this.state.gamePhase)return;const s=this.state.players.findIndex(e=>e.id===t);if(-1===s||s!==this.state.currentTurnIndex)return;const n=this.state.players[s];if(!this.playerHasCards(n,e))return;const r=this.getCombination(e);if(r&&this.canBeat(r,this.state.lastCombination)){if(this.removeCardsFromHand(n,e),this.state.currentTrick.push({playerId:t,cards:e}),this.state.lastPlayedBy=t,this.state.lastCombination=r,0===n.hand.length){this.state.rankings.includes(t)||this.state.rankings.push(t),this.state.winner||(this.state.winner=t);const e=this.state.players.filter(t=>null!==t.id&&t.hand.length>0);if(e.length<=1){for(const t of e)t.id&&!this.state.rankings.includes(t.id)&&this.state.rankings.push(t.id);return this.state.gamePhase="ended",void this.clearSavedState()}if(0===e.filter(t=>!t.isBot).length){const t=e.sort((t,e)=>t.hand.length-e.hand.length);for(const e of t)e.id&&!this.state.rankings.includes(e.id)&&this.state.rankings.push(e.id);return this.state.gamePhase="ended",void this.clearSavedState()}}this.resolveTrickEnd()||this.advanceTurn(),this.checkBotTurn()}}handlePass(t){if("playing"!==this.state.gamePhase)return;const e=this.state.players.findIndex(e=>e.id===t);-1!==e&&e===this.state.currentTurnIndex&&this.state.lastCombination&&(this.state.players[e].passed=!0,this.resolveTrickEnd()||this.advanceTurn(),this.checkBotTurn())}advanceTurn(){let t=(this.state.currentTurnIndex+1)%4,e=0;for(;e<4;){const s=this.state.players[t];if(null!==s.id&&s.hand.length>0&&!s.passed)break;t=(t+1)%4,e++}this.state.currentTurnIndex=t}resolveTrickEnd(){if(!this.state.lastPlayedBy)return!1;if(this.state.players.filter(t=>null!==t.id&&t.hand.length>0).every(t=>t.id===this.state.lastPlayedBy||t.passed)){this.state.currentTrick=[],this.state.lastCombination=null,this.state.players.forEach(t=>t.passed=!1);const t=this.state.players.findIndex(t=>t.id===this.state.lastPlayedBy);if(-1!==t){this.state.currentTurnIndex=t;0===this.state.players[t].hand.length&&this.advanceTurn()}return!0}return!1}playerHasCards(t,e){return e.every(e=>t.hand.some(t=>t===e))}removeCardsFromHand(t,e){for(const s of e){const e=t.hand.findIndex(t=>t===s);-1!==e&&t.hand.splice(e,1)}}handleAddBot(t){if(t<0||t>=4)return;if("waiting"!==this.state.gamePhase)return;if(null!==this.state.players[t].id)return;const e=`BOT_${t}_${Date.now()}`;this.state.players[t]={id:e,username:`Bot ${t+1}`,hand:[],isBot:!0,isHost:!1,passed:!1}}handleJoinSlot(t,e,s){t<0||t>=4||"waiting"===this.state.gamePhase&&null===this.state.players[t].id&&(this.state.players.some(t=>t.id===e)||(this.state.players[t]={id:e,username:s,hand:[],isBot:!1,isHost:!1,passed:!1}))}handleRemovePlayer(t){t<0||t>=4||"waiting"===this.state.gamePhase&&(this.state.players[t]={id:null,username:`Slot ${t+1}`,hand:[],isBot:!1,isHost:!1,passed:!1})}handleStartGame(){if("waiting"!==this.state.gamePhase)return;if(this.state.players.filter(t=>null!==t.id).length<2)return;this.dealCards(),this.state.gamePhase="playing";const t=["cautious","aggressive","balanced"];this.state.players.forEach(e=>{e.isBot&&(e.persona=t[Math.floor(Math.random()*t.length)])}),this.state.currentTurnIndex=this.findStartingPlayer(),this.state.currentTrick=[],this.state.lastCombination=null,this.state.lastPlayedBy=null,this.checkBotTurn()}findStartingPlayer(){for(let t=0;t<4;t++){const r=this.state.players[t];if(r.id&&r.hand.some(t=>t===n(s.THREE,e.SPADE)))return t}return this.state.players.findIndex(t=>null!==t.id)}handleNewGameRequest(t,e){this.isHost?this.reset():this.state.newGameRequest={fromId:t,fromName:e}}reset(){const t=this.state.players.map((t,e)=>({id:t.id,username:t.username,hand:[],isBot:t.isBot,isHost:t.isHost,passed:!1}));this.state={players:t,currentTrick:[],currentTurnIndex:0,lastPlayedBy:null,lastCombination:null,winner:null,rankings:[],gamePhase:"waiting",newGameRequest:null},this.selectedHandPattern="random"}checkGameEnd(){return this.state.winner?{winner:this.state.winner}:null}updatePlayers(t){for(let e=0;e<4;e++){const s=this.state.players[e];if(!s.isBot){const n=t.find(t=>t.id===s.id);n?s.username=n.username:(s.id=null,s.username=`Slot ${e+1}`,s.hand=[],s.passed=!1),s.isHost||this.setHandPattern("random")}}}checkBotTurn(){if(!this.isHost)return;if("playing"!==this.state.gamePhase)return;const t=this.state.players[this.state.currentTurnIndex];t.isBot&&t.id&&setTimeout(()=>this.makeBotMove(t),800)}makeBotMove(t){if("playing"!==this.state.gamePhase)return;if(!t.id)return;const e=this.findValidPlay(t.hand,t.persona||"balanced");e?this.handlePlayCards(t.id,e):this.state.lastCombination?this.handlePass(t.id):this.handlePlayCards(t.id,[t.hand[0]])}findValidPlay(t,e){const n=this.state.lastCombination;if("cautious"===e&&n){const e=this.isOpponentNearFinish();if(n.value>=s.ACE&&t.length>3&&!e)return null}if(!n)return this.findBestOpeningPlay(t,e);switch(n.type){case r.SINGLE:{const e=this.state.currentTrick[this.state.currentTrick.length-1].cards;if(i(e[0]).rank===s.TWO){const e=this.findThreeConsecutivePairs(t);if(e.length>0)return e[0];const s=this.findFourOfAKind(t);if(s.length>0)return s[0];const n=this.findFourConsecutivePairs(t);if(n.length>0)return n[0]}return this.findBeatingSingle(t,n)}case r.PAIR:{const e=this.state.currentTrick[this.state.currentTrick.length-1].cards;if(i(e[0]).rank===s.TWO){const e=this.findFourOfAKind(t);if(e.length>0)return e[0];const s=this.findFourConsecutivePairs(t);if(s.length>0)return s[0]}return this.findBeatingPair(t,n)}case r.TRIPLE:return this.findBeatingTriple(t,n);case r.STRAIGHT:return this.findBeatingStraight(t,n);default:return null}}findBeatingSingle(t,e){const s=this.state.currentTrick[this.state.currentTrick.length-1].cards[0];for(const n of t)if(n>s)return[n];return null}findBeatingPair(t,e){const s=e.value,n=this.groupByRank(t);for(const r of Object.values(n))if(r.length>=2){const t=r.slice(0,2),e=this.getCombination(t);if(e&&e.value>s)return t}return null}findBeatingTriple(t,e){const s=e.value,n=this.groupByRank(t);for(const r of Object.values(n))if(r.length>=3){const t=r.slice(0,3),e=this.getCombination(t);if(e&&e.value>s)return t}return null}findBeatingStraight(t,e){const s=e.cardCount,n=e.value;for(let i=0;i<=t.length-s;i++){const e=t.slice(i,i+s),a=this.getCombination(e);if(a&&a.type===r.STRAIGHT&&a.value>n)return e}return null}groupByRank(t){const e={};for(const s of t){const{rank:t}=i(s);e[t]||(e[t]=[]),e[t].push(s)}return e}isOpponentNearFinish(t=2){return this.state.players.some((e,s)=>s!==this.state.currentTurnIndex&&null!==e.id&&e.hand.length===t)}findBestOpeningPlay(t,e){const s=this.isOpponentNearFinish(),n=this.findStraights(t);if(n.length>0)return n.sort((t,e)=>e.length-t.length),n[0];const r=t.length<5,i=!s&&!r,a=this.findTriples(t,i);if(a.length>0)return a[0];const h=this.findPairs(t,i);if(h.length>0)return h[0];if(s||"aggressive"===e&&t.length<8||t.length<5){const e=this.findThreeConsecutivePairs(t);if(e.length>0)return e[0];const s=this.findFourOfAKind(t);if(s.length>0)return s[0]}return s?[t[t.length-1]]:[t[0]]}getSuggestion(t,e){if(0===e.length)return[];const s=e[e.length-1],n=this.findAllCombinationsWithCard(t,s).filter(t=>{if(this.state.lastCombination){const e=this.getCombination(t);return e&&this.canBeat(e,this.state.lastCombination)}return!0});return 0===n.length?[]:(n.sort((t,e)=>{if(e.length!==t.length)return e.length-t.length;const s=this.getCombination(t),n=this.getCombination(e);return s&&n?s.value-n.value:0}),n[0])}findAllCombinationsWithCard(t,e){const s=[],n=i(e).rank,r=this.findStraightsWaitCard(t,e);s.push(...r);const a=t.filter(t=>i(t).rank===n);if(a.sort((t,e)=>t-e),4===a.length&&s.push(a),a.length>=3)if(4===a.length){const t=a.filter(t=>t!==e);for(let n=0;n<t.length;n++)for(let r=n+1;r<t.length;r++)s.push([e,t[n],t[r]].sort((t,e)=>t-e))}else s.push(a);if(a.length>=2){const t=a.filter(t=>t!==e);for(const n of t)s.push([e,n].sort((t,e)=>t-e))}const h=this.findThreeConsecutivePairs(t);for(const i of h)i.includes(e)&&s.push(i);const l=this.findFourConsecutivePairs(t);for(const i of l)i.includes(e)&&s.push(i);return s.push([e]),s}findStraightsWaitCard(t,e){if(i(e).rank===s.TWO)return[];const n=[],r=t.filter(t=>i(t).rank!==s.TWO),a=this.groupByRank(r),h=Object.keys(a).map(Number).sort((t,e)=>t-e),l=i(e).rank;if(!h.includes(l))return[];for(let s=0;s<h.length;s++){const t=[h[s]];for(let r=s+1;r<h.length&&h[r]===t[t.length-1]+1;r++)if(t.push(h[r]),t.length>=3&&t.includes(l)){const s=t[t.length-1],r=t.slice(0,-1),i=s===l?[e]:a[s];for(const t of i){const s=[t];for(const t of r)t===l?s.push(e):s.push(a[t][0]);n.push(s.sort((t,e)=>t-e))}}}return n}findConsecutivePairs(t,e){const n=this.groupByRank(t),r=Object.keys(n).map(Number).sort((t,e)=>t-e),i=[];for(let a=0;a<=r.length-e;a++){const t=[];for(let h=0;h<e;h++){const l=r[a+h];if(h>0&&l!==r[a+h-1]+1||l===s.TWO||n[l].length<2)break;if(h===e-1){const e=[];for(let t=0;t<n[l].length;t++)for(let s=t+1;s<n[l].length;s++)e.push([n[l][t],n[l][s]]);for(const s of e)i.push([...t,...s])}else t.push(...n[l].slice(0,2))}}return i}findThreeConsecutivePairs(t){return this.findConsecutivePairs(t,3)}findFourConsecutivePairs(t){return this.findConsecutivePairs(t,4)}findPairs(t,e=!1){const n=this.groupByRank(t),r=[];for(const[i,a]of Object.entries(n))e&&Number(i)===s.TWO||a.length>=2&&r.push(a.slice(0,2));return r.sort((t,e)=>i(t[0]).rank-i(e[0]).rank)}findTriples(t,e=!1){const n=this.groupByRank(t),r=[];for(const[i,a]of Object.entries(n))e&&Number(i)===s.TWO||a.length>=3&&r.push(a.slice(0,3));return r.sort((t,e)=>i(t[0]).rank-i(e[0]).rank)}findFourOfAKind(t){const e=this.groupByRank(t),s=[];for(const n of Object.values(e))4===n.length&&s.push(n);return s.sort((t,e)=>i(t[0]).rank-i(e[0]).rank)}findStraights(t){const e=[],n=t.filter(t=>i(t).rank!==s.TWO),r=this.groupByRank(n),a=Object.keys(r).map(Number).sort((t,e)=>t-e);let h=[];for(let s=0;s<a.length;s++){const t=a[s];0===h.length||t===h[h.length-1]+1?h.push(t):(h.length>=3&&e.push(h.map(t=>r[t][0])),h=[t])}return h.length>=3&&e.push(h.map(t=>r[t][0])),e.sort((t,e)=>e.length-t.length),e}requestPlayCards(t){const e={type:"PLAY_CARDS",playerId:this.userId,cards:t};this.makeAction(e)}requestPass(){const t={type:"PASS",playerId:this.userId};this.makeAction(t)}requestAddBot(t){const e={type:"ADD_BOT",slotIndex:t};this.makeAction(e)}requestJoinSlot(t,e){const s={type:"JOIN_SLOT",slotIndex:t,playerId:this.userId,playerName:e};this.makeAction(s)}requestRemovePlayer(t){const e={type:"REMOVE_PLAYER",slotIndex:t};this.makeAction(e)}requestStartGame(){this.makeAction({type:"START_GAME"})}requestNewGame(){const t={type:"REQUEST_NEW_GAME",playerId:this.userId,playerName:""};this.makeAction(t)}acceptNewGame(){this.isHost&&this.onSocketGameAction({action:{type:"ACCEPT_NEW_GAME"}})}declineNewGame(){this.isHost&&this.onSocketGameAction({action:{type:"DECLINE_NEW_GAME"}})}getMyPlayerIndex(){return this.state.players.findIndex(t=>t.id===this.userId)}getUserId(){return this.userId}canStartGame(){if("waiting"!==this.state.gamePhase)return!1;return this.state.players.filter(t=>null!==t.id).length>=2}validateSelectedCards(t){if(0===t.length)return{valid:!1,error:{vi:"Vui lòng chọn bài để chơi",en:"Select cards to play"}};const e=this.getCombination(t);if(!e)return 2===t.length?{valid:!1,error:{vi:"Bài phải là đôi",en:"Cards must be a pair (same rank)"}}:3===t.length?{valid:!1,error:{vi:"Bài phải là ba hoặc sảnh",en:"Cards must be a triple or straight"}}:t.length>=4?{valid:!1,error:{vi:"Bài không hợp lệ (thử sảnh hoặc tứ quý)",en:"Invalid combination (try straight or four-of-a-kind)"}}:{valid:!1,error:{vi:"Bài không hợp lệ",en:"Invalid card selection"}};const n=this.state.lastCombination;if(!n)return{valid:!0};if(e.type!==n.type){const t=this.state.currentTrick[this.state.currentTrick.length-1].cards,h=i(t[0]).rank;return(n.type!==r.SINGLE||h!==s.TWO||e.type!==r.FOUR_OF_KIND&&e.type!==r.THREE_CONSECUTIVE_PAIRS&&e.type!==r.FOUR_CONSECUTIVE_PAIRS)&&((n.type!==r.PAIR||h!==s.TWO||e.type!==r.FOUR_OF_KIND&&e.type!==r.FOUR_CONSECUTIVE_PAIRS)&&(n.type!==r.THREE_CONSECUTIVE_PAIRS||e.type!==r.FOUR_OF_KIND&&e.type!==r.FOUR_CONSECUTIVE_PAIRS))?n.type===r.FOUR_OF_KIND&&e.type===r.FOUR_CONSECUTIVE_PAIRS?{valid:!0}:{valid:!1,error:{vi:`Phải chơi ${a[n.type].vi}`,en:`Must play ${a[n.type].en}`}}:{valid:!0}}return e.type===r.STRAIGHT&&e.cardCount!==n.cardCount?{valid:!1,error:{vi:`Sảnh phải có ${n.cardCount} lá bài`,en:`Straight must have ${n.cardCount} cards`}}:e.value<=n.value?{valid:!1,error:{en:"Your cards are too low",vi:"Bài của bạn quá thấp"}}:{valid:!0}}}export{h as default};
