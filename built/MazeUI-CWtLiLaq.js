import{u as e,b as t,j as s}from"./index-9u-zBydf.js";import{c as n,a6 as r,aU as l,aV as o,z as i,aW as a,aX as c,a8 as d,aD as h}from"./react-vendor-CFBbA8Qg.js";import{DIFFICULTY_CONFIG as u}from"./Maze-ToQ_lzaX.js";import{u as x}from"./useGameState-Dq_coqf5.js";import"./socket-DRbsQkF5.js";import"./zustand-0-40VJZq.js";import"./BaseGame-BFlLojRk.js";const m=(e,t,s)=>{const n=window.devicePixelRatio||1;e.width=t*n,e.height=s*n,e.style.width=`${t}px`,e.style.height=`${s}px`;const r=e.getContext("2d");return r&&r.scale(n,n),r},f=({game:f,currentUserId:g})=>{const p=f,[w]=x(p),v=n.useRef(null),y=n.useRef(null),b=n.useRef(null),j=n.useRef({}),{ts:N}=e(),{confirm:E}=t(),[T,k]=n.useState(30),P=g?w.players[g]:void 0,S=n.useMemo(()=>p.getMazeGrid(),[w.config,w.seed,p]);n.useEffect(()=>{const e=()=>{if(!b.current)return;const{rows:e,cols:t}=w.config,s=Math.min(window.innerWidth-32,800),n=window.innerHeight-180-32,r=Math.floor(s/t),l=Math.floor(n/e);let o=Math.min(r,l);o=Math.max(10,Math.min(o,40)),k(o)};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[w.config.rows,w.config.cols]);const[z,R]=n.useState(!1);n.useEffect(()=>{const e=()=>{R(!!document.fullscreenElement)};return document.addEventListener("fullscreenchange",e),()=>{document.removeEventListener("fullscreenchange",e)}},[]);const L=n.useRef(void 0),[M,I]=n.useState(!1),[G,A]=n.useState(new Set),D=n.useRef(new Set);n.useEffect(()=>{const e=new Set;A(e),D.current=e},[w.seed,w.level,w.status,p]),n.useEffect(()=>{if(!P)return;const e=Date.now();if(!(P.moveEnd&&e<P.moveEnd&&P.currentPath&&P.currentPath.length>=2)){const e=`${P.x},${P.y}`;D.current.has(e)||(D.current.add(e),A(new Set(D.current)))}},[P?.x,P?.y,P?.moveEnd,P?.currentPath,M]),n.useEffect(()=>{const e=y.current;if(!e)return;const{rows:t,cols:s}=w.config,n=s*T,r=t*T,l=m(e,n,r);l&&(l.clearRect(0,0,n,r),P&&(l.fillStyle=P.color+"33",G.forEach(e=>{const[t,s]=e.split(",").map(Number);l.fillRect(t*T,s*T,T,T)})))},[G,w.config.rows,w.config.cols,T,P]),n.useEffect(()=>{const e=v.current;if(!e||!S)return;const{rows:t,cols:s}=w.config,n=s*T,r=t*T,l=m(e,n,r);if(l){l.clearRect(0,0,n,r),l.fillStyle="rgba(34, 197, 94, 0.2)",l.fillRect((s-1)*T,(t-1)*T,T,T),l.fillStyle="rgba(59, 130, 246, 0.2)",l.fillRect(0,0,T,T),l.lineWidth=3;for(let e=0;e<t;e++)for(let t=0;t<s;t++){const s=S?.[e]?.[t];if(s?.portalTo){const n=t*T+T/2,r=e*T+T/2;l.beginPath(),l.arc(n,r,.35*T,0,2*Math.PI),l.fillStyle=s.portalTo.color+"40",l.fill(),l.beginPath(),l.arc(n,r,.25*T,0,2*Math.PI),l.strokeStyle=s.portalTo.color,l.stroke(),l.beginPath(),l.arc(n,r,.1*T,0,2*Math.PI),l.fillStyle=s.portalTo.color,l.fill()}}l.strokeStyle="#4b5563",l.lineWidth=2,l.lineCap="round",l.beginPath();for(let e=0;e<t;e++)for(let t=0;t<s;t++){const s=S[e][t],n=t*T,r=e*T;s.walls.top&&(l.moveTo(n,r),l.lineTo(n+T,r)),s.walls.right&&(l.moveTo(n+T,r),l.lineTo(n+T,r+T)),s.walls.bottom&&(l.moveTo(n,r+T),l.lineTo(n+T,r+T)),s.walls.left&&(l.moveTo(n,r),l.lineTo(n,r+T))}l.stroke()}},[S,w.config.rows,w.config.cols,T]),n.useEffect(()=>{const e=e=>{if("PLAYING"!==w.status)return;let t=null;"ArrowUp"===e.key&&(t="UP"),"ArrowDown"===e.key&&(t="DOWN"),"ArrowLeft"===e.key&&(t="LEFT"),"ArrowRight"===e.key&&(t="RIGHT")," "===e.key&&H(),t&&(e.preventDefault(),O(t))};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[w.status,p]),n.useEffect(()=>{let e=!1;const t=()=>{const s=Date.now();if(Object.values(w.players).forEach(e=>{const t=j.current[e.id];if(!t)return;let n=e.x,r=e.y;if(e.moveStart&&e.moveEnd&&e.currentPath&&e.currentPath.length>=2&&s<e.moveEnd){const t=e.moveEnd-e.moveStart,l=s-e.moveStart,o=Math.max(0,Math.min(l/t,1)),i=e.currentPath,a=i.length-1,c=o*a,d=Math.floor(c),h=c-d;if(d<a){const e=i[d],t=i[d+1];n=e.x+(t.x-e.x)*h,r=e.y+(t.y-e.y)*h}if(e.id===g){let e=!1;for(let t=0;t<=d&&t<i.length;t++){const s=i[t],n=`${s.x},${s.y}`;D.current.has(n)||(D.current.add(n),e=!0)}e&&A(new Set(D.current))}}t.style.left=n*T+.15*T+"px",t.style.top=r*T+.15*T+"px",t.style.width=.7*T+"px",t.style.height=.7*T+"px"}),g&&w.players[g]){const t=w.players[g],n=!!(t.moveEnd&&s<t.moveEnd);n!==e&&(e=n,I(n))}L.current=requestAnimationFrame(t)};return L.current=requestAnimationFrame(t),()=>{L.current&&cancelAnimationFrame(L.current)}},[w.players,g,T]);const F=n.useMemo(()=>{if(!P||!S||M)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const{x:e,y:t}=P;if(t<0||e<0||t>=w.config.rows||e>=w.config.cols)return{UP:!1,DOWN:!1,LEFT:!1,RIGHT:!1};const s=S[t][e];return{UP:!s.walls.top,DOWN:!s.walls.bottom,LEFT:!s.walls.left,RIGHT:!s.walls.right}},[P?.x,P?.y,S,w.config,M]),C=e=>{const t=w.winners.indexOf(e);return-1===t?void 0:t+1},H=()=>{g&&p.makeAction({type:"TELEPORT",playerId:g})},O=e=>{g&&p.makeAction({type:"MOVE",direction:e,playerId:g})};return s.jsxs("div",{className:"flex flex-col items-center justify-center min-h-full @md:p-4 p-2 overflow-hidden pb-16!",ref:b,children:[s.jsx("div",{className:"flex flex-col w-full max-w-2xl bg-gray-800 @md:p-4 p-2 rounded-xl shadow-lg gap-4 z-10 shrink-0",children:s.jsxs("div",{className:"flex items-center justify-between w-full gap-2",children:[s.jsxs("div",{className:"flex flex-col",children:[s.jsxs("span",{className:"text-sm text-gray-400",children:["Level ",w.level," ",s.jsx("span",{className:"text-xs text-gray-500 bg-gray-700 px-2 py-0.5 rounded-full",children:w.config.difficulty})]}),s.jsxs("div",{className:"flex gap-1 mt-2",children:[p.isHost&&s.jsx("button",{onClick:async()=>{await E(N({en:"Current progress will be lost",vi:"Tiến trình hiện tại sẽ mất"}),N({en:"Reset Game?",vi:"Chơi lại?"}))&&p.makeAction({type:"RESET_GAME"})},className:"p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg",title:"Reset Game",children:s.jsx(r,{size:18})}),s.jsx("button",{onClick:()=>{b.current&&(document.fullscreenElement?document.exitFullscreen():b.current.requestFullscreen().catch(e=>{console.error(`Error attempting to enable fullscreen: ${e.message}`)}))},className:"p-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg",title:z?"Exit Fullscreen":"Fullscreen",children:z?s.jsx(l,{size:18}):s.jsx(o,{size:18})})]})]}),s.jsx("div",{className:"flex flex-col flex-wrap gap-0",children:Object.values(w.players).map(e=>s.jsxs("div",{className:"flex items-center gap-2 p-1.5 px-3 bg-gray-900/50 rounded-lg border border-gray-700/50",children:[s.jsx("div",{className:"w-3 h-3 rounded-full border border-white/20 shrink-0",style:{backgroundColor:e.color}}),s.jsxs("div",{className:"truncate font-medium text-sm text-gray-300 max-w-[100px]",children:[e.username||e.id.slice(0,8),e.id===g&&s.jsxs("span",{className:"text-blue-400 ml-1",children:["(",N({en:"You",vi:"Bạn"}),")"]})]}),C(e.id)&&s.jsxs("span",{className:"text-xs font-bold bg-green-500/20 text-green-400 px-1.5 py-0.5 rounded ml-1",children:["#",C(e.id)]})]},e.id))})]})}),s.jsxs("div",{className:"relative shadow-2xl rounded-lg border border-gray-700 select-none bg-[#1a1a1a] mt-4 shrink-0 transition-all duration-300",style:{width:w.config.cols*T,height:w.config.rows*T},children:[s.jsxs("div",{className:"absolute inset-0 overflow-hidden rounded-lg",children:[s.jsx("canvas",{ref:y,className:"absolute inset-0 z-0",style:{width:"100%",height:"100%"}}),s.jsx("canvas",{ref:v,className:"absolute inset-0 z-10",style:{width:"100%",height:"100%"}}),Object.values(w.players).map(e=>s.jsx("div",{ref:t=>{j.current[e.id]=t},className:"absolute rounded-full shadow-sm flex items-center justify-center border-2 border-white",style:{width:.7*T+"px",height:.7*T+"px",left:e.x*T+.15*T+"px",top:e.y*T+.15*T+"px",backgroundColor:e.color,zIndex:e.id===g?20:10},children:C(e.id)&&s.jsxs("span",{className:"text-xs font-bold text-white drop-shadow-md",children:["#",C(e.id)]})},e.id)),"WAITING"===w.status&&s.jsxs("div",{className:"absolute inset-0 bg-black/40 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[s.jsx("div",{className:"text-white text-3xl font-bold",children:p.isHost?N({en:"Setup Game",vi:"Cài đặt Game"}):N({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})}),p.isHost&&s.jsxs("div",{className:"flex flex-col gap-4 items-center animate-in fade-in zoom-in duration-300",children:[s.jsx("div",{className:"flex bg-gray-800 rounded-lg p-1.5 ring-1 ring-gray-700",children:Object.keys(u).map(e=>s.jsx("button",{onClick:()=>{return t=e,void p.makeAction({type:"UPDATE_SETTINGS",difficulty:t});var t},className:"px-4 py-2 text-sm font-bold rounded-md transition-all "+(w.config.difficulty===e?"bg-blue-600 text-white shadow-lg":"text-gray-400 hover:text-white hover:bg-gray-700"),children:e},e))}),s.jsxs("button",{onClick:()=>{p.makeAction({type:"START_GAME"})},className:"flex items-center gap-2 px-8 py-3 bg-green-600 hover:bg-green-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-green-500/20 transition-all hover:-translate-y-0.5",children:[s.jsx(i,{size:24,fill:"currentColor"})," ",N({en:"Start Game",vi:"Chơi"})]})]})]}),"FINISHED"===w.status&&s.jsxs("div",{className:"absolute inset-0 bg-black/80 flex flex-col items-center justify-center gap-6 z-50 p-4 text-center",children:[s.jsxs("div",{className:"text-green-400 text-4xl font-bold drop-shadow-[0_0_10px_rgba(74,222,128,0.5)]",children:[N({en:"Level Complete!",vi:"Xong Level"})," ",w.level]}),P&&C(P.id)&&s.jsxs("div",{className:"text-white text-xl",children:[N({en:"You finished",vi:"Bạn về đích"})," ",s.jsxs("span",{className:"font-bold text-yellow-400",children:["#",C(P.id)]})]}),p.isHost?s.jsxs("button",{onClick:()=>{p.makeAction({type:"NEXT_LEVEL"})},className:"flex items-center gap-2 px-8 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-lg shadow-lg hover:shadow-blue-500/20 transition-all hover:-translate-y-0.5",children:[N({en:"Next Level",vi:"Level tiếp theo"})," ",s.jsx(i,{size:24,fill:"currentColor"})]}):s.jsx("div",{children:N({en:"Waiting for Host...",vi:"Đang chờ chủ phòng..."})})]})]}),(()=>{if("PLAYING"!==w.status||!P||M||C(P.id))return null;const e=40,t=P.x*T+T/2,n=P.y*T+T/2,l=w.config.cols*T,o=w.config.rows*T,i=F.LEFT?60:20,u=F.RIGHT?60:20,x=F.UP?60:20,m=F.DOWN?60:20,f=Math.max(i,Math.min(l-u,t)),g=Math.max(x,Math.min(o-m,n)),p=(e,t)=>({width:"40px",height:"40px",left:f+e-20+"px",top:g+t-20+"px"}),v="absolute flex items-center justify-center bg-white/10 hover:bg-white/40 rounded-full backdrop-blur-sm transition-all hover:scale-110 active:scale-95 z-30 border border-white/10 shadow-lg ring-1 ring-black/20 opacity-50";return s.jsxs(s.Fragment,{children:[F.UP&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),O("UP")},className:v,style:p(0,-40),children:s.jsx(a,{size:24,className:"text-white drop-shadow-md"})}),F.DOWN&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),O("DOWN")},className:v,style:p(0,e),children:s.jsx(c,{size:24,className:"text-white drop-shadow-md"})}),F.LEFT&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),O("LEFT")},className:v,style:p(-40,0),children:s.jsx(d,{size:24,className:"text-white drop-shadow-md"})}),F.RIGHT&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),O("RIGHT")},className:v,style:p(e,0),children:s.jsx(h,{size:24,className:"text-white drop-shadow-md"})}),S?.[P.y]?.[P.x]?.portalTo&&s.jsx("button",{onPointerDown:e=>{e.stopPropagation(),H()},className:"absolute flex items-center justify-center bg-purple-500/80 hover:bg-purple-400 rounded-full backdrop-blur-sm transition-all hover:scale-110 active:scale-95 z-40 border border-white/20 shadow-[0_0_15px_rgba(168,85,247,0.5)] animate-pulse opacity-50",style:{width:"40px",height:"40px",left:f-20+"px",top:g-20+"px"},children:s.jsx(r,{size:24,className:"text-white drop-shadow-md animate-spin",style:{animationDirection:"reverse"}})})]})})()]}),s.jsx("div",{className:"mt-4 text-gray-500 text-sm hidden sm:block",children:N({vi:"Về đích đầu tiên để dành chiến thắng",en:"First to the finish wins!"})})]})};export{f as default};
