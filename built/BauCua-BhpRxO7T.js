import{B as t}from"./BaseGame-CegFuiXV.js";import{I as e,M as s,a,A as r,J as o,b as i,P as n}from"./types-BWSiALex.js";import"./socket-DRbsQkF5.js";import"./index-BID1u12v.js";import"./react-vendor-BYtLKAeB.js";import"./zustand-BLoNJECv.js";class l extends t{botMoveTimeout=null;getInitState(){const t={},s={};return this.players.forEach(a=>{t[a.id]={playerId:a.id,username:a.username,currentBalance:e,balanceHistory:[e],totalBet:0,isBot:a.isBot||!1},s[a.id]=this.initializePowerUps()}),{gamePhase:"waiting",playerBalances:t,currentBets:{},diceRoll:null,currentRound:0,playersReady:{},winner:null,playerPowerUps:s,activePowerUps:{},powerUpPredictions:{},recentRolls:[],isMegaRound:!1,jackpotPool:0}}initializePowerUps(){return{double_down:{type:"double_down",cooldown:0,lastUsedRound:-1},insurance:{type:"insurance",cooldown:0,lastUsedRound:-1},reveal_one:{type:"reveal_one",cooldown:0,lastUsedRound:-1},lucky_star:{type:"lucky_star",cooldown:0,lastUsedRound:-1}}}onSocketGameAction(t){const e=t.action;if(this.isHost)switch(e.type){case"PLACE_BET":this.handlePlaceBet(e.playerId,e.symbol,e.amount);break;case"CLEAR_BETS":this.handleClearBets(e.playerId);break;case"SYNC_BETS":this.handleSyncBets(e.playerId,e.bets);break;case"TOGGLE_READY":this.handleToggleReady(e.playerId);break;case"ROLL_DICE":this.handleRollDice();break;case"START_NEW_ROUND":this.handleStartNewRound();break;case"RESET_GAME":this.handleResetGame();break;case"ADD_BOT":this.handleAddBot();break;case"REMOVE_BOT":this.handleRemoveBot(e.playerId);break;case"ACTIVATE_POWERUP":this.handleActivatePowerUp(e.playerId,e.powerUpType);break;case"DEACTIVATE_POWERUP":this.handleDeactivatePowerUp(e.playerId)}}handlePlaceBet(t,e,r){if("betting"!==this.state.gamePhase)return;const o=this.state.playerBalances[t];if(!o)return;const i=this.state.currentBets[t]||[],n=i.reduce((t,e)=>t+e.amount,0),l=o.currentBalance-n,c=Math.min(r,l);if(c<s)return;if(c>a)return;const h=i.findIndex(t=>t.symbol===e);h>=0?i[h].amount+=c:i.push({symbol:e,amount:c}),this.state.currentBets[t]=i,this.state.playerBalances[t].totalBet=n+c,this.syncState()}handleClearBets(t){"betting"===this.state.gamePhase&&(this.state.currentBets[t]=[],this.state.playerBalances[t].totalBet=0,this.state.playersReady[t]=!1,this.syncState())}handleSyncBets(t,e){if("betting"!==this.state.gamePhase)return;const s=this.state.playerBalances[t];if(!s)return;const a=e.reduce((t,e)=>t+e.amount,0);a>s.currentBalance||(this.state.currentBets[t]=e,this.state.playerBalances[t].totalBet=a,this.syncState())}handleToggleReady(t){if("betting"!==this.state.gamePhase)return;((this.state.currentBets[t]||[]).length>0||this.state.playersReady[t])&&(this.state.playersReady[t]=!this.state.playersReady[t],this.syncState())}handleRollDice(){if("betting"!==this.state.gamePhase)return;if(0===Object.keys(this.state.currentBets).filter(t=>(this.state.currentBets[t]||[]).length>0).length)return void this.handleStartNewRound();this.state.gamePhase="rolling";const t=[r[Math.floor(Math.random()*r.length)],r[Math.floor(Math.random()*r.length)],r[Math.floor(Math.random()*r.length)]];Object.keys(this.state.powerUpPredictions).forEach(e=>{const s=this.state.powerUpPredictions[e];if("reveal_one"===this.state.activePowerUps[e]){const e=t.includes(s.symbol),a=Math.random()<s.accuracy;if(s.actuallyCorrect=a,a&&!e){const e=Math.floor(3*Math.random());t[e]=s.symbol}else if(!a&&e){const e=t.map((t,e)=>t===s.symbol?e:-1).filter(t=>t>=0);if(e.length>0){const a=r.filter(t=>t!==s.symbol),o=e[Math.floor(Math.random()*e.length)];t[o]=a[Math.floor(Math.random()*a.length)]}}}}),this.state.diceRoll=[t[0],t[1],t[2]],this.state.recentRolls.push([t[0],t[1],t[2]]),this.state.recentRolls.length>10&&this.state.recentRolls.shift(),this.syncState(),setTimeout(()=>{this.calculateResults()},3500)}calculateResults(){if(!this.state.diceRoll)return;const t=this.state.diceRoll,e={gourd:0,crab:0,shrimp:0,fish:0,chicken:0,deer:0};t.forEach(t=>{e[t]++});const s=t[0]===t[1]&&t[1]===t[2],a=s?t[0]:null;let r=0;this.state.isMegaRound&&a&&(r=Object.values(this.state.currentBets).filter(t=>t.some(t=>t.symbol===a)).length);let i=0;Object.keys(this.state.currentBets).forEach(t=>{const s=this.state.currentBets[t]||[],o=this.state.playerBalances[t];if(!o)return;let n=0,l=0,c=0;const h=this.state.activePowerUps[t];if(s.forEach(t=>{l+=t.amount;const s=e[t.symbol];if(s>0){let e=t.amount,o=t.amount*s;"double_down"===h&&(o*=2),e+=o,n+=e,this.state.isMegaRound&&a===t.symbol&&r>0&&(n+=Math.floor(this.state.jackpotPool/r))}else c+=t.amount}),i+=l,"insurance"===h&&c>0&&(n+=Math.floor(.5*c)),"lucky_star"===h&&n>0){const e=3.5*Math.random()+1.5;n=Math.floor(n*e),this.state.playerPowerUps[t]?.lucky_star&&(this.state.playerPowerUps[t].lucky_star.lastMultiplier=e)}const d=o.currentBalance-l+n;o.currentBalance=Math.max(0,d),o.balanceHistory.push(o.currentBalance),o.totalBet=0}),this.state.jackpotPool+=Math.floor(i*o),this.state.isMegaRound&&s&&(this.state.jackpotPool=0),Object.keys(this.state.playerPowerUps).forEach(t=>{const e=this.state.playerPowerUps[t];e&&Object.values(e).forEach(t=>{t.cooldown>0&&t.cooldown--})}),this.state.activePowerUps={},this.state.powerUpPredictions={},this.state.gamePhase="results",this.state.currentRound++,this.state.isMegaRound=this.state.currentRound%5==0,this.checkGameOver(),this.syncState()}checkGameOver(){const t=Object.values(this.state.playerBalances).filter(t=>t.currentBalance>0);1===t.length&&(this.state.gamePhase="ended",this.state.winner=t[0].playerId)}handleStartNewRound(){this.state.gamePhase="betting",this.state.currentBets={},this.state.diceRoll=null,this.state.playersReady={},this.state.isMegaRound=this.state.currentRound>0&&this.state.currentRound%i===0,this.state.powerUpPredictions={},this.syncState(),this.checkBotTurn()}handleResetGame(){Object.keys(this.state.playerBalances).forEach(t=>{const s=this.state.playerBalances[t];s.currentBalance=e,s.balanceHistory=[e],s.totalBet=0,this.state.playerPowerUps[t]=this.initializePowerUps()}),this.state.gamePhase="waiting",this.state.currentBets={},this.state.diceRoll=null,this.state.currentRound=0,this.state.playersReady={},this.state.winner=null,this.state.activePowerUps={},this.state.powerUpPredictions={},this.state.recentRolls=[],this.state.isMegaRound=!1,this.state.jackpotPool=0,this.syncState(),this.checkBotTurn()}handleAddBot(){const t=`BOT_${Date.now()}`,s=`Bot ${Object.keys(this.state.playerBalances).length+1}`;this.state.playerBalances[t]={playerId:t,username:s,currentBalance:e,balanceHistory:[e],totalBet:0,isBot:!0},this.state.playerPowerUps[t]=this.initializePowerUps(),this.syncState(),this.checkBotTurn()}handleRemoveBot(t){const e=this.state.playerBalances[t];e&&e.isBot&&(delete this.state.playerBalances[t],delete this.state.currentBets[t],delete this.state.playersReady[t],delete this.state.playerPowerUps[t],delete this.state.activePowerUps[t],this.syncState())}checkBotTurn(){this.isHost&&"betting"===this.state.gamePhase&&(this.botMoveTimeout&&clearTimeout(this.botMoveTimeout),this.botMoveTimeout=setTimeout(()=>{this.executeBotActions()},800))}executeBotActions(){Object.values(this.state.playerBalances).filter(t=>t.isBot).forEach(t=>{if(this.state.playersReady[t.playerId])return;const e=this.state.playerPowerUps[t.playerId];if(e&&Math.random()<.3){const s=[];if(0===e.double_down.cooldown&&s.push("double_down"),0===e.insurance.cooldown&&s.push("insurance"),s.length>0){const e=t.currentBalance>500&&s.includes("double_down")?"double_down":s[Math.floor(Math.random()*s.length)];this.handleActivatePowerUp(t.playerId,e)}}const s=Math.random();let a=1;a=s<.3?Math.random()<.5?1:2:s<.7?Math.random()<.5?2:3:Math.random()<.5?3:4;const o=[...r],i=Math.floor(t.currentBalance/(2*a));for(let r=0;r<a&&o.length>0;r++){const e=Math.floor(Math.random()*o.length),s=o[e];o.splice(e,1),this.handlePlaceBet(t.playerId,s,i)}this.state.playersReady[t.playerId]=!0}),this.syncState()}requestPlaceBet(t,e){this.makeAction({type:"PLACE_BET",playerId:this.userId,symbol:t,amount:e})}requestClearBets(){this.makeAction({type:"CLEAR_BETS",playerId:this.userId})}requestSyncBets(t){this.makeAction({type:"SYNC_BETS",playerId:this.userId,bets:t})}requestToggleReady(){this.makeAction({type:"TOGGLE_READY",playerId:this.userId})}requestRollDice(){this.makeAction({type:"ROLL_DICE"})}requestStartNewRound(){this.makeAction({type:"START_NEW_ROUND"})}requestResetGame(){this.makeAction({type:"RESET_GAME"})}requestAddBot(){this.makeAction({type:"ADD_BOT"})}requestRemoveBot(t){this.makeAction({type:"REMOVE_BOT",playerId:t})}requestActivatePowerUp(t){this.makeAction({type:"ACTIVATE_POWERUP",playerId:this.userId,powerUpType:t})}requestDeactivatePowerUp(){this.makeAction({type:"DEACTIVATE_POWERUP",playerId:this.userId})}randInRange(t,e){return Math.floor(Math.random()*(e-t+1))+t}handleActivatePowerUp(t,e){if("betting"!==this.state.gamePhase)return;const s=this.state.playerPowerUps[t];if(!s)return;const a=s[e];if(!a||a.cooldown>0)return;const o=n[e];if("pre_roll"===o.timing&&"reveal_one"===e){const e=r[this.randInRange(0,5)],s=this.randInRange(o.accuracy?.[0]||.6,o.accuracy?.[1]||.9);this.state.powerUpPredictions[t]={symbol:e,accuracy:s}}this.state.activePowerUps[t]=e,a.cooldown=o.cooldown,a.lastUsedRound=this.state.currentRound,this.syncState()}handleDeactivatePowerUp(t){if("betting"!==this.state.gamePhase)return;const e=this.state.activePowerUps[t];if(!e)return;if("post_roll"!==n[e].timing)return;const s=this.state.playerPowerUps[t];if(!s)return;const a=s[e];a&&(a.cooldown=0,a.lastUsedRound=-1,this.state.activePowerUps[t]=null,this.syncState())}updatePlayers(t){super.updatePlayers(t),t.forEach(t=>{this.state.playerBalances[t.id]||(this.state.playerBalances[t.id]={playerId:t.id,username:t.username,currentBalance:e,balanceHistory:[e],totalBet:0,isBot:t.isBot||!1},this.state.playerPowerUps[t.id]=this.initializePowerUps())});const s=new Set(t.map(t=>t.id));Object.keys(this.state.playerBalances).forEach(t=>{const e=this.state.playerBalances[t].isBot;s.has(t)||e||(delete this.state.playerBalances[t],delete this.state.currentBets[t],delete this.state.playersReady[t],delete this.state.playerPowerUps[t],delete this.state.activePowerUps[t])}),this.syncState()}destroy(){this.botMoveTimeout&&clearTimeout(this.botMoveTimeout),super.destroy()}}export{l as default};
